import os
import shutil
import zipfile
import re
import jmcomic
from jmcomic import create_option, JmHtmlClient

# ================= é…ç½®åŒºåŸŸ (é€‚é… GitHub Actions) =================
# 1. ä¼˜å…ˆä»ç¯å¢ƒå˜é‡è·å–ï¼Œè·å–ä¸åˆ°åˆ™ä½¿ç”¨é»˜è®¤å€¼
# åœ¨ GitHub Actions ä¸­ï¼Œè¿™äº›å€¼ä¼šé€šè¿‡ secrets æˆ– inputs ä¼ å…¥
JM_USERNAME = os.getenv("JM_USERNAME", "ä½ çš„ç”¨æˆ·å")
JM_PASSWORD = os.getenv("JM_PASSWORD", "ä½ çš„å¯†ç ")

# 2. æ¼«ç”» ID (æ”¯æŒä»ç¯å¢ƒå˜é‡è¯»å– "123-456" è¿™ç§æ ¼å¼)
# é»˜è®¤å€¼ç•™ç©ºï¼Œç­‰å¾…è¾“å…¥
ENV_ALBUM_IDS = os.getenv("JM_ALBUM_IDS", "") 
DEFAULT_ALBUM_ID = "438696" 

# 3. åŸŸåè®¾ç½®
DOMAIN_LIST = [
    '18comic.vip', '18comic.org', 'jmcomic.me', 'jmcomic1.me', 'jm-comic.cc',
    'jmcomic.rocks', 'jmcomic.group'
]

# 4. è·¯å¾„é…ç½®
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
# GitHub Actions é€šå¸¸åœ¨ workspace ä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ download ç›®å½•
DOWNLOAD_DIR = os.path.join(BASE_DIR, "download")
# ===============================================================

def natural_sort_key(s):
    return [int(text) if text.isdigit() else text.lower()
            for text in re.split('([0-9]+)', s)]

def unzip_if_needed(folder_path):
    if not os.path.exists(folder_path): return
    for f in os.listdir(folder_path):
        if f.endswith('.zip'):
            src = os.path.join(folder_path, f)
            dst = os.path.join(folder_path, os.path.splitext(f)[0])
            try:
                with zipfile.ZipFile(src, 'r') as zf: zf.extractall(dst)
                os.remove(src)
            except: pass

def process_comic_for_comfyui(comic_root):
    """
    åæœŸå¤„ç†ï¼šåˆå¹¶ç« èŠ‚ã€é‡å‘½åï¼Œä½¿å…¶é€‚åˆ ComfyUI
    """
    comic_name = os.path.basename(comic_root)
    # ä¸ºäº†é˜²æ­¢æ–‡ä»¶åä¹±ç æˆ–è¿‡é•¿ï¼ŒGitHub Actions Artifact æœ‰æ—¶æœ‰é™åˆ¶ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
    merged_dir = os.path.join(BASE_DIR, f"{comic_name}_Merged")
    
    if os.path.exists(merged_dir): shutil.rmtree(merged_dir)
    os.makedirs(merged_dir)
    
    print(f"\nğŸ”„ [åæœŸå¤„ç†] æ­£åœ¨åˆå¹¶ç« èŠ‚å¹¶é‡å‘½å: {comic_name}...")
    unzip_if_needed(comic_root)
    
    # æŸ¥æ‰¾ç« èŠ‚
    chapters = [d for d in os.listdir(comic_root) if os.path.isdir(os.path.join(comic_root, d))]
    chapters.sort(key=natural_sort_key)
    
    if not chapters:
        print(f"âŒ {comic_name} æœªæ‰¾åˆ°ç« èŠ‚æ–‡ä»¶å¤¹ï¼Œè·³è¿‡ã€‚")
        return None

    global_count = 1
    for chapter in chapters:
        c_path = os.path.join(comic_root, chapter)
        images = [f for f in os.listdir(c_path) if f.lower().endswith(('.jpg','.png','.webp','.jpeg'))]
        images.sort(key=natural_sort_key)
        
        print(f"   -> åˆå¹¶ç« èŠ‚: {chapter} ({len(images)}å¼ )")
        
        for img in images:
            ext = os.path.splitext(img)[1] or ".jpg"
            new_name = f"{global_count:05d}{ext}"
            shutil.copy2(os.path.join(c_path, img), os.path.join(merged_dir, new_name))
            global_count += 1
            
    return merged_dir

def get_album_ids():
    """è§£æè¦ä¸‹è½½çš„ ID åˆ—è¡¨"""
    if ENV_ALBUM_IDS:
        # æ”¯æŒç”¨ - æˆ– , æˆ– ç©ºæ ¼ åˆ†éš”
        return re.split(r'[-,\s]+', ENV_ALBUM_IDS)
    return [DEFAULT_ALBUM_ID]

def run():
    # æ£€æŸ¥è´¦å·
    if "ä½ çš„ç”¨æˆ·å" in JM_USERNAME:
        print("âš ï¸ è­¦å‘Šï¼šæœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„ JM_USERNAMEï¼Œè¯·æ£€æŸ¥ Secrets è®¾ç½®ï¼")

    # æ„å»ºé…ç½®
    jm_config = {
        'dir_rule': {'base_dir': DOWNLOAD_DIR},
        'client': {
            'username': JM_USERNAME,
            'password': JM_PASSWORD,
            'domain_list': DOMAIN_LIST,
        }
    }

    # åˆ›å»º Option
    option = create_option(jm_config)
    
    album_ids = get_album_ids()
    print(f"ğŸš€ å‡†å¤‡ä¸‹è½½ ID åˆ—è¡¨: {album_ids}")

    for aid in album_ids:
        if not aid: continue
        try:
            print(f"\n------ å¼€å§‹ä¸‹è½½ ID: {aid} ------")
            jmcomic.download_album(aid, option)
            
            # å¯»æ‰¾åˆšæ‰ä¸‹è½½çš„æ–‡ä»¶å¤¹
            if not os.path.exists(DOWNLOAD_DIR): continue
            
            # æ‰¾åˆ°è¯¥ ID å¯¹åº”çš„æ¼«ç”»ç›®å½•ï¼ˆé€šè¿‡æœ€åä¿®æ”¹æ—¶é—´ï¼‰
            # æ³¨æ„ï¼šå¦‚æœå¹¶å‘ä¸‹è½½å¤šä¸ªå¯èƒ½ä¼šæ··æ·†ï¼Œè¿™é‡Œå‡è®¾æ˜¯ä¸€ä¸ªä¸ªå¤„ç†
            subfolders = [f.path for f in os.scandir(DOWNLOAD_DIR) if f.is_dir()]
            if not subfolders: continue
            
            # ç®€å•çš„é€»è¾‘ï¼šå–æœ€æ–°çš„æ–‡ä»¶å¤¹ä½œä¸ºåˆšåˆšä¸‹è½½çš„
            target_comic = max(subfolders, key=os.path.getmtime)
            
            # æ‰§è¡Œåˆå¹¶é€»è¾‘
            process_comic_for_comfyui(target_comic)
            
            # æ¸…ç†åŸå§‹ä¸‹è½½æ–‡ä»¶ï¼ŒèŠ‚çœç©ºé—´
            try: shutil.rmtree(target_comic)
            except: pass

        except Exception as e:
            print(f"âŒ ä¸‹è½½ ID {aid} å¤±è´¥: {e}")

    print("\nâœ… æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæˆï¼")

if __name__ == "__main__":
    run()
